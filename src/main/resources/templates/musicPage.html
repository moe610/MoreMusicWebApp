<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Page</title>
</head>
<body>

<h2>Music Page</h2>

<audio controls id="audio-player" mediagroup="audioGroup">
  <source src="" type="audio/aac" id="audio-source">
  Your browser does not support the audio element.
</audio>
<br />
<button id="play-button">Play</button>
<br />
<button id="next-button">Next</button>
<br />
<button id="previous-button">Previous</button>
<br />
<a href="/upload-music">Upload Music</a>

<script>
  const audio = document.getElementById('audio-player');
  const playButton = document.getElementById('play-button');
  const nextButton = document.getElementById('next-button');
  const previousButton = document.getElementById('previous-button');

  let audioFiles = []; // Initialize empty array
  let shuffledIndices = [];
  let currentIndex = 0;
  let currentShuffleIndex = 0;

  function togglePlay() {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
    updatePlayButtonState();
  }

  function updatePlayButtonState() {
    playButton.textContent = audio.paused ? 'Play' : 'Pause';
  }

  function playNextAudio() {
    currentShuffleIndex = (currentShuffleIndex + 1) % shuffledIndices.length;
    currentIndex = shuffledIndices[currentShuffleIndex];
    loadAudioFile(currentIndex);
  }

  function playPreviousAudio() {
    currentShuffleIndex = (currentShuffleIndex - 1 + shuffledIndices.length) % shuffledIndices.length;
    currentIndex = shuffledIndices[currentShuffleIndex];
    loadAudioFile(currentIndex);
  }

  function loadAudioFile(index) {
    if (index >= 0 && index < audioFiles.length) {
      const newFile = audioFiles[index];
      const audioSource = document.getElementById('audio-source');
      audioSource.src = '/MusicFiles/' + encodeURIComponent(newFile.fileName);
      audio.load();
      audio.play().catch(error => console.error('Error playing audio:', error));
      updateMediaSessionMetadata(newFile);
    } else {
      console.error('Invalid index:', index);
    }
  }

  function shuffleArrayIndices(length) {
    let indices = Array.from({ length }, (_, index) => index);
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    return indices;
  }

  function updateMediaSessionMetadata(audioFile) {
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: audioFile.title || "Track Title",
        artist: audioFile.artist || "Artist Name",
        album: audioFile.album || "Album Name",
        artwork: [
          { src: audioFile.artworkPath || "/path-to-artwork.jpg", sizes: "96x96", type: "image/jpeg" },
        ],
      });
      navigator.mediaSession.setActionHandler('nexttrack', () => {
        console.log('User clicked "Next Track" icon.');
        skipForward();
      });
      navigator.mediaSession.setActionHandler('previoustrack', () => {
        console.log('User clicked "Previous Track" icon.');
        skipBackward();
      });
      navigator.mediaSession.setActionHandler('play', () => {
        console.log('User clicked "Play" icon.');
        togglePlay();
      });
      navigator.mediaSession.setActionHandler('pause', () => {
        console.log('User clicked "Pause" icon.');
        togglePlay();
      });
    }
  }

  function skipForward() {
    playNextAudio();
  }

  function skipBackward() {
    playPreviousAudio();
  }

  // Fetch audio files from your REST API
  fetch('/api/v1/audioFiles')
          .then(response => response.json())
          .then(files => {
            audioFiles = files;
            shuffledIndices = shuffleArrayIndices(audioFiles.length);
            currentIndex = 0;
            currentShuffleIndex = 0;

            playButton.addEventListener('click', togglePlay);
            nextButton.addEventListener('click', playNextAudio);
            previousButton.addEventListener('click', playPreviousAudio);

            // Initialize media session metadata
            if (audioFiles.length > 0) {
              loadAudioFile(currentIndex);
            }
          })
          .catch(error => console.error('Error fetching audio files:', error));
</script>

</body>
</html>
